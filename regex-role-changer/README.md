# Regex Role Changer
PT AI из коробки не поддерживает гибкое назначение проектных ролей для пользователей. Для решения этой проблемы мы предлагаем использовать данный скрипт. С помощью него можно быстро выдать разработчику доступ к сканированиям всех его микросервисов, если их названия можно сгруппировать по регулярному выражению.

## Запуск
Находясь в директории проекта написать в консоли:

`pip install -r requirements.txt`

`python ./main.py -h`

```
usage: main.py [-h] [--regcheck] [--insecure] filename

Скрипт для назначения ролей в проектах PTAI на основе регулярных выражений

Позиционные аргументы:
  filename    имя CSV файла с данными

Опции:
  -h, --help  показать данную справку и выйти
  --regcheck  вывести список проектов, попадающих под регулярные выражения из csv файла
  --insecure  отключить проверку SSL-сертификатов
```

## Работа со скриптом
Для начала работы необходимо указать данные для подключения к PTAI в файле `consts.py`.\
Формат записи:

```
URL = "https://ptai.site.com/" # Обязательно с "/" в конце
LOGIN = "root"
PASSWORD = "password"
```

**Примечание:** программа будет завершать работу, если по данным, указанным в `consts.py` невозможно подключиться.

**Примечание:** подключение возможно ТОЛЬКО от локальной учетной записи (root).

### Входные данные
Данный скрипт принимает в качестве входных данных CSV-файл в формате:

```
user,rolename,regex
Ivanov Ivan,Project Manager,\[TEST\].*
Ivanov Ivan,Project Manager,GRO-.*-test
Semenov Semen,Developer,ABCD-EF-.*
Alisovna Alisa,Auditor,ali.*ss
Alisovna Alisa,Разработчик + изменение статуса,.*vuln.*
```

| Столбец  | Описание                                                    | Принимаемые значения                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|----------|-------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| user     | Имя пользователя, которому будет назначен указанный проект  | Имя пользователя по SSO, поле **name (не login!).**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| rolename | Роль, которую необходимо назначить пользователю             | `Auditor` - аудитор: просматривает проекты, на которые назначен, но не обладает полномочиями по их настройке. Может управлять статусами найденных уязвимостей и удалять результаты сканирования.<br> `Project Manager` - менеджер безопасности: имеет полный доступ к проектам, на которые он назначен.<br> `Developer` - разработчик: просматривает проекты, на которые он назначен. Видит результаты проекта, а также может создавать задачи в Jira.<br> **При использовании пользовательских ролей необходимо указывать полное название роли (даже если оно на русском)** |
| regex    | Регулярное выражение, по которому происходит поиск проектов | Любое регулярное выражение, поддерживаемое движком Python. Проверить можно [здесь](https://regex101.com/).                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

**Примечание:** поскольку при отсутствии в csv файле пользователя с назначенным проектом, он будет снят с этого проекта, в репозитории присутствует скрипт для создания baseline файла, в него можно добавлять новые данные.\
Использование:
```
python export_project_roles.py [куда сохранить]
```
Если не указан выходной файл, данные будут сохранены в output.csv

### Режим загрузки (по-умолчанию)
Данный режим позволяет обновить проектные роли, добавить новые и удалить старые.
Перед применением изменений скрипт выводит окончательный список ролей и запрашивает подтверждение у пользователя.
Если пользователь напишет любое слово, кроме "д", "да", "y" или "yes", изменения не будут применены и скрипт завершит свою работу.\
**Внимание:** скрипт не отображает удалённые проектные роли

```
====== Новые проектные роли для пользователей ======
## Ivanov Ivan
Project Manager: [TEST] MyProject, [TEST] TheWorld, GRO-123-test, GRO-abc-test

## Semenov Semen
Developer: ABCD-EF-123, ABCD-EF-xyz

## Alisovna Alisa
Auditor: alisaexpress
Разработчик + изменение статуса: totalynotvulnerableapp

Внимание! Если пользователь не указан в списке, у него удалятся все роли, не назначенные автоматически!
Если вы хотите только добавить новые роли, но оставить все старые, вставьте вывод скрипта export_project_roles.py в csv-файл.
Изменить? [y/N]
```

### Режим проверки
Данный режим позволяет проверить все регулярные выражения, указанные в файле.
Он выводит список всех проектов в системе, которые соответствуют данному регулярному выражению.
Чтобы использовать данный режим, необходимо перед указанием пути до файла добавить флаг `--regcheck`.

```
\[TEST\].*: [TEST] MyProject, [TEST] TheWorld
GRO-.*-test: GRO-123-test, GRO-abc-test
ABCD-EF-.*: ABCD-EF-123, ABCD-EF-xyz
ali.*ss: alisaexpress
.*vuln.*: totalynotvulnerableapp
```
